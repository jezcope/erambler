#!/usr/bin/env ruby

require 'compass'

Compass.add_project_configuration 'config/compass.rb'

# Preprocess ###################################################################

preprocess do
  reset_cache
  
	paginate_articles

  tag_index.add_articles(articles)
  tag_index.create_tag_feeds(@items)
  tag_index.create_tag_pages(@items)

  articles.each {|item| item[:page_type] = 'single-post'}
  @items.each   {|item| item[:page_type] ||= 'static-page'}
end

# Compilation ##################################################################

KRAMDOWN_OPTIONS = {
  input: :GFM,
  syntax_highlighter: :rouge
}

STATIC_ITEMS = Regexp.union(
  '/favicon.ico/',
  '/robots.txt/',
  '/blank.html/',
  %r{/assets/(images|fonts|javascripts)/.*/},
  %r{/downloads/.*/}
)
compile STATIC_ITEMS do
  # Don't compile
end

compile '/assets/style/*/' do
  filter :sass, Compass.sass_engine_options
end

compile '/assets/js/*/' do
  if item[:extension] == 'coffee'
    filter :coffeescript
  end
  filter :uglify_js
end

compile %r{^(/|/archives/.*/)$} do
  filter :haml
  layout 'main'
end

compile '/articles/*' do
  filter :erb
  filter :kramdown, KRAMDOWN_OPTIONS if @item[:extension] == 'md'
  layout 'main'
end

compile '/articles/*', rep: :archive do
  filter :erb
  filter :kramdown, KRAMDOWN_OPTIONS if @item[:extension] == 'md'
  filter :reduce_header_level, by: 1
end

compile %r{^(/feeds?/.*|/sitemap/|/ignore-me/)$} do
  filter :haml
end

compile %r{^/(tag|category)/} do
  filter :haml
  layout 'main' unless item[:type] == :feed
end

compile '*' do
  case @item[:extension]
  when 'md'
    filter :erb
    filter :kramdown, KRAMDOWN_OPTIONS
  when 'haml'
    filter :haml, format: :html5
  else
    filter :erb
  end
  layout 'main'
end

# Routing ######################################################################

route '/assets/style/partials/*' do
  # Don't route
end

# route %r{^(/assets/images/.*/|/favicon/|/downloads/.*/)$} do
#   item.identifier.chop + '.' + item[:extension]
# end
route STATIC_ITEMS do
  item.identifier.chomp('/')
end

route '/assets/style/*/' do
  item.identifier.chop + '.css'
end

route '/assets/js/*/' do
  item.identifier.chop + '.js'
end

route '/articles/*/' do
  '/blog/' + item.identifier.to_s.split('/')[-1] + '/index.html'
end

route '/articles/*/', rep: :archive do
  # Don't route
end

route %r{/(feed|sitemap)/$} do
  item.identifier.chop + '.xml'
end

route '*' do
  item.identifier + 'index.html'
end

# Layouts ######################################################################

layout '*', :haml, format: :html5, ugly: true
