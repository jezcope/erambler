#!/usr/bin/env ruby

require 'compass'

Compass.add_project_configuration 'config/compass.rb'

# Preprocess ###################################################################

preprocess do
	paginate_articles

  tag_index.add_articles(articles)
  @items.concat(tag_index.tag_feeds)
  @items.concat(tag_index.tag_pages)
end

# Compilation ##################################################################

STATIC_ITEMS = [
  '/favicon/',
  '/robots/',
  '/blank/',
  %r{/assets/images/.*/},
  %r{/downloads/.*/}
]
compile Regexp.union(*STATIC_ITEMS) do
  # Don't compile
end

compile '/assets/style/*/' do
  filter :sass, Compass.sass_engine_options
end

compile '/assets/js/*/' do
  if item[:extension] == 'coffee'
    filter :coffee
  end
  filter :uglify_js
end

compile %r{^(/|/archives/.*/)$} do
  filter :haml
  layout 'home'
end

compile '/articles/*' do
  filter :erb
  filter :kramdown
  layout 'article'
end

compile '/articles/*', :rep => :archive do
  filter :kramdown
  filter :reduce_header_level, :by => 2
end

compile %r{^(/feeds?/.*|/sitemap/|/ignore-me/)$} do
  filter :haml
end

compile '/tag/*' do
  filter :haml
  layout 'home'
end

compile '*' do
  case @item[:extension]
  when 'md'
    filter :erb
    filter :kramdown
  when 'haml'
    filter :haml, :format => :html5
  else
    filter :erb
  end
  layout 'page'
end

# Routing ######################################################################

route '/assets/style/partials/*' do
  # Don't route
end

route %r{^(/assets/images/.*/|/favicon/|/downloads/.*/)$} do
  item.identifier.chop + '.' + item[:extension]
end

route '/assets/style/*/' do
  item.identifier.chop + '.css'
end

route '/assets/js/*/' do
  item.identifier.chop + '.js'
end

route '/articles/*/' do
	'/blog/' + item.identifier.split('/')[-1] + '/index.html'
end

route '/articles/*/', :rep => :archive do
  # Don't route
end

route %r{^(/feed/|/feeds/.*/|/sitemap/)$} do
  item.identifier.chop + '.xml'
end

route '/robots/' do
  '/robots.txt'
end

route '/blank/' do
  '/blank.html'
end

route '*' do
  item.identifier + 'index.html'
end

# Layouts ######################################################################

layout '*', :haml, :format => :html5
