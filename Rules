#!/usr/bin/env ruby

require 'compass'

Compass.add_project_configuration 'config/compass.rb'

# Preprocess ###################################################################

preprocess do
	paginate_articles

  tag_index.add_articles(articles)
  tag_index.create_tag_feeds(@items)
  tag_index.create_tag_pages(@items)

  articles.each {|item| item[:page_type] = 'single-post'}
  @items.each   {|item| item[:page_type] ||= 'static-page'}

  validate_items
end

# Compilation ##################################################################

KRAMDOWN_OPTIONS = {
  input: :GFM,
  syntax_highlighter: :rouge
}

STATIC_ITEMS = Regexp.union(
  '/favicon.ico',
  '/robots.txt',
  '/blank.html',
  '/blogroll/feeds/',
  %r{\A/assets/(images|fonts|javascripts)/.*},
  %r{\A/downloads/},
  %r{/images/.*}
)
compile STATIC_ITEMS do
  nil
end

compile '/assets/style/*/' do
  filter :sass, Compass.sass_engine_options
end

compile '/assets/js/*/' do
  if item[:extension] == 'coffee'
    filter :coffeescript
  end
  filter :uglify_js
end

compile %r{^(/|/archives/.*/)$} do
  filter :haml
  layout 'main'
  filter :relativize_paths, type: :html
end

compile '/articles/*' do
  filter :erb
  filter :kramdown, KRAMDOWN_OPTIONS if @item[:extension] == 'md'
  layout 'main'
  filter :relativize_paths, type: :html
end

compile '/articles/*', rep: :archive do
  filter :erb
  filter :kramdown, KRAMDOWN_OPTIONS if @item[:extension] == 'md'
end

compile %r{^(/feeds?/.*|/sitemap/|/ignore-me/)$} do
  filter :haml, format: :xhtml
end

compile %r{^/(tag|category)/} do
  filter :haml
  layout 'main' unless item[:type] == :feed
  filter :relativize_paths, type: :html
end

compile '*' do
  case @item[:extension]
  when 'md'
    filter :erb
    filter :kramdown, KRAMDOWN_OPTIONS
  when 'haml'
    filter :haml, format: :html5
  else
    filter :erb
  end
  layout 'main'
  filter :relativize_paths, type: :html
end

# Routing ######################################################################

route '/assets/style/partials/*' do
  # Don't route
end

route '/blogroll/feeds/' do
  item.identifier.chop + '.opml'
end

route STATIC_ITEMS do
  item.identifier.to_s
end

route '/assets/style/*/' do
  item.identifier.chop + '.css'
end

route '/assets/js/*/' do
  item.identifier.chop + '.js'
end

route '/articles/*/' do
  '/blog/' + item.identifier.to_s.split('/')[-1] + '/index.html'
end

route '/articles/*/', rep: :archive do
  # Don't route
  nil
end

route %r{/(feed|sitemap)/$} do
  item.identifier.chop + '.xml'
end

route '*' do
  item.identifier + 'index.html'
end

# Layouts ######################################################################

layout '*', :haml, format: :html5, ugly: true
